(function(){"use strict";var adminbookingapp;adminbookingapp=angular.module("BBAdminDashboard",["trNgGrid","BBAdmin","BBAdminServices","ui.calendar","ngStorage","BBAdminBooking"]),angular.module("BBAdminDashboard").config(function($logProvider){return $logProvider.debugEnabled(!0)}),angular.module("BBAdminDashboard.Directives",[]),angular.module("BBAdminDashboard.Services",["ngResource","ngSanitize","ngLocalData"]),angular.module("BBAdminDashboard.Controllers",["ngLocalData","ngSanitize"])}).call(this),function(){angular.module("BBAdminDashboard").directive("bbIfLogin",function($modal,$log,$q,$rootScope,AdminCompanyService,$compile,$templateCache,ModalForm,BBModel){var compile,link;return compile=function(){return{pre:function(scope,element,attributes){return scope.notLoaded=function(sc){return null},scope.setLoaded=function(sc){return null},scope.setPageLoaded=function(){return null},$rootScope.start_deferred=$q.defer(),$rootScope.connection_started=$rootScope.start_deferred.promise,this.whenready=$q.defer(),scope.loggedin=this.whenready.promise,AdminCompanyService.query(attributes).then(function(company){return scope.company=company,scope.bb||(scope.bb={}),scope.bb.company=company,this.whenready.resolve(),$rootScope.start_deferred.resolve()})},post:function(scope,element,attributes){}}},link=function(scope,element,attrs){},{compile:compile}})}.call(this),function(){angular.module("BBAdminDashboard").directive("bbResourceCalendar",function(uiCalendarConfig,AdminCompanyService,AdminBookingService,AdminPersonService,$q,$sessionStorage,ModalForm,BBModel,AdminBookingPopup,$window,$bbug,ColorPalette,AppConfig,Dialog,$interval,$http,$timeout,$compile,$templateCache,BookingCollections){var controller,link;return controller=function($scope,$attrs){var height;return $scope.eventSources=[{events:function(start,end,timezone,callback){return $scope.loading=!0,$scope.getCompanyPromise().then(function(company){var params;return params={company:company,start_date:start.format("YYYY-MM-DD"),end_date:end.format("YYYY-MM-DD")},AdminBookingService.query(params).then(function(bookings){var b,i,len,ref;for($scope.loading=!1,ref=bookings.items,i=0,len=ref.length;len>i;i++)b=ref[i],b.resourceId=b.person_id;return $scope.bookings=bookings.items,callback($scope.bookings)})})}}],$scope.options=$scope.$eval($attrs.bbResourceCalendar),$scope.options||($scope.options={}),height=$scope.options.header_height?$bbug($window).height()-$scope.options.header_height:800,$scope.uiCalOptions={calendar:{eventStartEditable:!0,eventDurationEditable:!1,height:height,header:{left:"today,prev,next",center:"title",right:"timelineDay,agendaWeek,month"},defaultView:"timelineDay",views:{agendaWeek:{slotDuration:$scope.options.slotDuration||"00:05"},month:{eventLimit:5},timelineDay:{slotDuration:$scope.options.slotDuration||"00:05",eventOverlap:!1,slotWidth:44}},resourceLabelText:"Staff",selectable:!0,resources:function(callback){return $scope.getPeople(callback)},eventDrop:function(event,delta,revertFunc){return Dialog.confirm({model:event,body:"Are you sure you want to move this booking?",success:function(_this){return function(model){return $scope.updateBooking(event)}}(this),fail:function(){return revertFunc()}})},eventClick:function(event,jsEvent,view){return $scope.editBooking(event)},resourceRender:function(resource,resourceTDs,dataTDs){var dataTD,i,j,len,len1,resourceTD,results;for(i=0,len=resourceTDs.length;len>i;i++)resourceTD=resourceTDs[i],resourceTD.style.height="44px",resourceTD.style.verticalAlign="middle";for(results=[],j=0,len1=dataTDs.length;len1>j;j++)dataTD=dataTDs[j],results.push(dataTD.style.height="44px");return results},eventRender:function(event,element){var service;return service=_.findWhere($scope.services,{id:event.service_id}),service?(element.css("background-color",service.color),element.css("color",service.textColor),element.css("border-color",service.textColor)):void 0},eventAfterRender:function(event,elements,view){var element,i,len;if("timelineDay"===view.type)for(i=0,len=elements.length;len>i;i++)element=elements[i],element.style.height="27px";return elements.draggable()},select:function(start,end,jsEvent,view,resource){var rid;return view.calendar.unselect(),rid=null,resource&&(rid=resource.id),AdminBookingPopup.open({item_defaults:{date:start.format("YYYY-MM-DD"),time:60*start.hour()+start.minute(),person:rid}})},viewRender:function(view,element){var date;return date=uiCalendarConfig.calendars.resourceCalendar.fullCalendar("getDate"),$scope.currentDate=moment(date).format("YYYY-MM-DD")},eventResize:function(event,delta,revertFunc,jsEvent,ui,view){return event.duration=event.end.diff(event.start,"minutes"),$scope.updateBooking(event)}}},$scope.getPeople=function(callback){return $scope.loading=!0,$scope.getCompanyPromise().then(function(company){var params;return params={company:company},AdminPersonService.query(params).then(function(people){var i,len,p,ref;for($scope.loading=!1,$scope.people=_.sortBy(people,"name"),ref=$scope.people,i=0,len=ref.length;len>i;i++)p=ref[i],p.title=p.name;return uiCalendarConfig.calendars.resourceCalendar.fullCalendar("refetchEvents"),callback($scope.people)})})},$scope.updateBooking=function(booking){return booking.person_id=booking.resourceId,booking.$update().then(function(response){return booking.resourceId=booking.person_id,uiCalendarConfig.calendars.resourceCalendar.fullCalendar("updateEvent",booking)})},$scope.editBooking=function(booking){return ModalForm.edit({templateUrl:"edit_booking_modal_form.html",model:booking,title:"Edit Booking",success:function(_this){return function(response){return response.is_cancelled?uiCalendarConfig.calendars.resourceCalendar.fullCalendar("removeEvents",[response.id]):(booking.resourceId=booking.person_id,uiCalendarConfig.calendars.resourceCalendar.fullCalendar("updateEvent",booking))}}(this)})},$scope.pusherSubscribe=function(_this){return function(){return $scope.company?$scope.company.pusherSubscribe(function(res){var booking;return null!=res.id?(booking=_.first(uiCalendarConfig.calendars.resourceCalendar.fullCalendar("clientEvents",res.id)),booking?booking.$refetch().then(function(){return uiCalendarConfig.calendars.resourceCalendar.fullCalendar("updateEvent",booking)}):$scope.company.$get("bookings",{id:res.id}).then(function(response){return booking=new BBModel.Admin.Booking(response),BookingCollections.checkItems(booking),uiCalendarConfig.calendars.resourceCalendar.fullCalendar("refetchEvents")})):void 0},{encrypted:!1}):void 0}}(this),$scope.openDatePicker=function($event){return $event.preventDefault(),$event.stopPropagation(),$scope.datePickerOpened=!0},$scope.updateDate=function(date){return uiCalendarConfig.calendars.resourceCalendar?uiCalendarConfig.calendars.resourceCalendar.fullCalendar("gotoDate",date):void 0},$scope.lazyUpdateDate=_.debounce($scope.updateDate,400),$scope.datePickerOptions={showButtonBar:!1},$scope.$watch("currentDate",function(newDate,oldDate){return $scope.lazyUpdateDate(newDate)})},link=function(scope,element,attrs){return scope.getCompanyPromise=function(){var defer;return defer=$q.defer(),scope.company?defer.resolve(scope.company):AdminCompanyService.query(attrs).then(function(company){return scope.company=company,defer.resolve(scope.company)}),defer.promise},scope.getCompanyPromise().then(function(company){return company.$get("services").then(function(collection){return collection.$get("services").then(function(services){var s;return scope.services=function(){var i,len,results;for(results=[],i=0,len=services.length;len>i;i++)s=services[i],results.push(new BBModel.Admin.Service(s));return results}(),ColorPalette.setColors(scope.services)})})}),scope.getCompanyPromise().then(function(company){return scope.pusherSubscribe()}),$timeout(function(){var datePickerElement,toolbarElement,toolbarLeftElement,uiCalElement;return uiCalElement=angular.element(element.children()[1]),toolbarElement=angular.element(uiCalElement.children()[0]),toolbarLeftElement=angular.element(toolbarElement.children()[0]),scope.currentDate=moment().format(),datePickerElement=$compile($templateCache.get("calendar_date_picker.html"))(scope),toolbarLeftElement.append(datePickerElement)},0)},{controller:controller,link:link,templateUrl:"resource_calendar_main.html"}})}.call(this);